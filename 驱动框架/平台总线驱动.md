## å¹³å°æ€»çº¿æ¨¡å‹

åœ¨ Linux 2.6 ä»¥åçš„è®¾å¤‡é©±åŠ¨æ¨¡å‹ä¸­ï¼Œ éœ€å…³å¿ƒ **æ€»çº¿ã€ è®¾å¤‡å’Œé©±åŠ¨** è¿™ 3 ä¸ªå®ä½“ï¼Œ æ€»çº¿å°† **è®¾å¤‡å’Œé©±åŠ¨** ç»‘å®šã€‚

Linux è®¾å¤‡å’Œé©±åŠ¨é€šå¸¸éƒ½éœ€è¦æŒ‚æ¥åœ¨ä¸€ç§æ€»çº¿ä¸Šï¼Œ å¯¹äºæœ¬èº«ä¾é™„äº PCIã€ USBã€ I2Cã€ SPI ç­‰çš„è®¾å¤‡è€Œè¨€ï¼Œ è¿™è‡ªç„¶ä¸æ˜¯é—®é¢˜ã€‚ä½†æ˜¯åœ¨åµŒå…¥å¼ç³»ç»Ÿé‡Œé¢ï¼Œ åœ¨ SoC ç³»ç»Ÿä¸­é›†æˆçš„ç‹¬ç«‹å¤–è®¾æ§åˆ¶å™¨ã€ æŒ‚æ¥åœ¨ SoCå†…å­˜ç©ºé—´çš„å¤–è®¾ç­‰å´ä¸ä¾é™„äºæ­¤ç±»æ€»çº¿ã€‚

åŸºäºè¿™ä¸€èƒŒæ™¯ï¼Œ Linux å‘æ˜äº†ä¸€ç§ **è™šæ‹Ÿçš„æ€»çº¿**ï¼Œ ç§°ä¸º **platform æ€»çº¿**ï¼Œ ç›¸åº”çš„è®¾å¤‡ç§°ä¸º **platform_device**ï¼Œ é©±åŠ¨ç§°ä¸º **platform_driver**ã€‚

å¹³å°æ€»çº¿æ¨¡å‹å°±æ˜¯æŠŠåŸæ¥çš„ ä¸€ä¸ªé©±åŠ¨Cæ–‡ä»¶ åˆ†æˆäº† ä¸¤ä¸ª C æ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯ï¼š

**device.cï¼ˆæè¿°ç¡¬ä»¶ä¿¡æ¯ï¼Œè®¾å¤‡æ ‘å¯æ›¿ä»£ï¼‰**

**driver.cï¼ˆé©±åŠ¨ä¿¡æ¯æ§åˆ¶ç¡¬ä»¶ï¼‰**

![[å¹³å°æ€»çº¿.png]]

##### å·¥ä½œæ–¹å¼ï¼š

device.c å’Œ driver.c ä¸­åˆ†åˆ«æœ‰ä¸€ä¸ª**ç»“æ„ä½“**ï¼Œç»“æ„ä½“éƒ½æœ‰ **name**

å¹³å°æ€»çº¿ é€šè¿‡**å­—ç¬¦ä¸²æ¯”è¾ƒ**ï¼Œå°† **name ç›¸åŒ çš„ devcie.c å’Œ driver.c åŒ¹é…**ã€‚

### **platform è®¾å¤‡ ï¼ˆdevice.cï¼‰**

device.c ä¸­å†™çš„æ˜¯ **æè¿°ç¡¬ä»¶ä¿¡æ¯**ï¼Œç¡¬ä»¶èµ„æºæŒ‡çš„æ˜¯ **å¯„å­˜å™¨åœ°å€**ï¼Œ**ä¸­æ–­å·** ä»¥åŠ **å…¶ä»–ç¡¬ä»¶èµ„æº**ã€‚

#### platform è®¾å¤‡ **æ³¨å†Œ** åˆ° Linux å†…æ ¸ å‡½æ•°ï¼š


```c
int platform_device_register(struct platform_device *pdev)
```

`pdev`ï¼šè¦æ³¨å†Œçš„ platform è®¾å¤‡

**è¿”å›å€¼ï¼š** è´Ÿæ•°ï¼Œå¤±è´¥ï¼› 0ï¼ŒæˆåŠŸ

#### platform è®¾å¤‡ **å¸è½½å‡½æ•°**ï¼š

```c
void platform_device_unregister(struct platform_device *pdev)
```

`pdev`ï¼šè¦æ³¨é”€çš„ platform è®¾å¤‡

**è¿”å›å€¼ï¼š** æ— 

#### platform ç¡¬ä»¶è®¾å¤‡è®¾å¤‡ç»“æ„ä½“

**ç»“æ„ä½“ å®šä¹‰ åœ¨** `include/linux/platform_device.h` **ä¸­ã€‚**

ç¼–è¯‘åï¼Œname å¯åœ¨å¦‚ä¸‹è·¯å¾„æŸ¥çœ‹ï¼š

**`ls /sys/bus/platform/devices`**


å¤´æ–‡ä»¶ï¼š`#include <linux/platform_device.h>`
```c
struct platform_device {
	const char *name; // è®¾å¤‡åç§°ï¼Œè¦å’Œæ‰€ä½¿ç”¨çš„ platform é©±åŠ¨çš„ name å­—æ®µç›¸åŒ
	int id; // è®¾å¤‡ID ï¼Œè®¾ä¸º -1ä»£è¡¨æ²¡æœ‰ åç¼€
	bool id_auto; // æ˜¯å¦è‡ªåŠ¨åˆ†é…IDï¼Œä¸€èˆ¬ä¸ç”¨\
	struct device dev; // è®¾å¤‡ç»“æ„ä½“ï¼Œ
	u64 platform_dma_mask; // DMAæ©ç 
	struct device_dma_parameters dma_parms; // DMAå‚æ•°
	u32 num_resources; // èµ„æºæ•°é‡struct resource *resource; ç»“æ„ä½“ä¸­ å®šä¹‰äº†å‡ ä¸ª èµ„æºï¼Œè¿™é‡Œæ•°é‡å°±æ˜¯ å‡ ï¼Œå¯ç”¨ ARRAY_SIZE è·å–
	struct resource *resource; // ç¡¬ä»¶èµ„æºæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªèµ„æºç»“æ„ä½“æ•°ç»„ï¼Œå³è®¾å¤‡ä¿¡æ¯ï¼Œæ¯”å¦‚å¤–è®¾å¯„å­˜å™¨ç­‰
	const struct platform_device_id *id_entry; // è®¾å¤‡IDæ¡ç›®
	
	/*
	* Driver name to force a match. Do not set directly, because core
	* frees it. Use driver_set_override() to set or clear it.
	*/
	// å®šä¹‰ä¸€ä¸ªæŒ‡å‘å­—ç¬¦å¸¸é‡çš„æŒ‡é’ˆï¼Œç”¨äºå­˜å‚¨é©±åŠ¨è¦†ç›–ä¿¡æ¯
	const char *driver_override;
	
	// å®šä¹‰ä¸€ä¸ªæŒ‡å‘mfd_cellç»“æ„ä½“çš„æŒ‡é’ˆï¼Œç”¨äºå­˜å‚¨MFDï¼ˆMulti-Function Deviceï¼‰å•å…ƒçš„ç›¸å…³ä¿¡æ¯
	struct mfd_cell *mfd_cell;
	
	// å®šä¹‰ä¸€ä¸ªpdev_archdataç»“æ„ä½“ï¼Œç”¨äºå­˜å‚¨ä¸ä½“ç³»ç»“æ„ç›¸å…³çš„é™„åŠ ä¿¡æ¯
	struct pdev_archdata archdata;
};
```

**å¿…é¡»å®ç° struct device dev; ä¸­çš„å‡½æ•°ï¼š**
`void (*release)(struct device *dev);`

#### **ç¡¬ä»¶èµ„æºä¿¡æ¯å­˜æ”¾åœ¨ resource ç»“æ„ä½“ï¼š**

**è·¯å¾„ï¼š**`include/linux/ioport.h`

**å¤´æ–‡ä»¶ï¼š**`#include <linux/ioport.h>`
```c
structÂ resourceÂ {Â 
Â Â Â Â resource_size_tÂ start;Â Â //Â èµ„æºçš„èµ·å§‹åœ°å€Â 
Â Â Â Â resource_size_tÂ end;Â Â Â Â //Â èµ„æºçš„ç»“æŸåœ°å€Â 
Â Â Â Â constÂ charÂ *name;Â Â Â Â Â Â Â //Â èµ„æºçš„åç§°ï¼ŒæŒ‡å‘ä¸€ä¸ªå¸¸é‡å­—ç¬¦ä¸²Â 
Â Â Â Â unsigned longÂ flags;Â Â Â Â //Â èµ„æºç±»å‹ç§ç±»Â ï¼Œæ˜¯Â å®å®šä¹‰Â 
Â Â Â Â unsignedÂ longÂ desc;Â Â Â Â Â //Â èµ„æºçš„æè¿°ä¿¡æ¯ï¼Œå¯ä»¥ç”¨äºå­˜å‚¨é¢å¤–çš„ä¿¡æ¯Â 
Â Â Â Â 
Â Â Â Â //Â æŒ‡å‘Â çˆ¶èµ„æºã€å…„å¼Ÿèµ„æºã€å­èµ„æºÂ çš„æŒ‡é’ˆÂ 
Â Â Â Â structÂ resourceÂ *parent,Â *sibling,Â *child;Â 
};
```

**`include/linux/ioport.h` ä¹Ÿå¯æ‰¾åˆ° flag ç±»å‹ï¼š**

flagç±»å‹ç¤ºä¾‹ï¼š

```c
#define IORESOURCE_BITSÂ Â Â Â  0x000000ffÂ  /* Bus-specific bits */

#define IORESOURCE_TYPE_BITSÂ Â Â  0x00001f00Â  /* Resource type */

#define IORESOURCE_IOÂ Â Â Â Â Â  0x00000100Â  /* PCI/ISA I/O ports */

#define IORESOURCE_MEMÂ Â Â Â Â  0x00000200

#define IORESOURCE_REGÂ Â Â Â Â  0x00000300Â  /* Register offsets */

#define IORESOURCE_IRQÂ Â Â Â Â  0x00000400

#define IORESOURCE_DMAÂ Â Â Â Â  0x00000800

#define IORESOURCE_BUSÂ Â Â Â Â  0x00001000
```
ç¤ºä¾‹ï¼š

```c
#includeÂ <linux/module.h>Â 
#includeÂ <linux/init.h>Â 
#includeÂ <linux/ioport.h>Â 
#includeÂ <linux/platform_device.h>Â 

//Â resourceÂ ç»“æ„ä½“Â 
staticÂ structÂ resourceÂ my_device_resource[]Â =Â Â 
{Â Â Â //Â 2Â ä¸ªèµ„æºï¼Œç§ç±»ä¸åŒÂ 
Â Â Â Â [0]Â =Â {Â Â Â Â 
Â Â Â Â Â Â Â  .startÂ =Â 0xFDD60000,Â Â //Â å¯„å­˜å™¨èµ·å§‹åœ°å€Â 
Â Â Â Â Â Â Â  .endÂ =Â 0xFDD60004,Â Â Â //Â å¯„å­˜å™¨ç»“æŸåœ°å€Â 
Â Â Â Â Â Â Â  .flagsÂ =Â IORESOURCE_MEM,Â Â //Â å†…å­˜ç±»å‹èµ„æºÂ  ---ç´¢å¼•å·æ˜¯ 0ï¼Œåªæœ‰1 ä¸ª ä¸­å†…å­˜å‹èµ„æºÂ 
Â Â Â Â Â Â Â  .nameÂ =Â "reg",Â Â //Â nameÂ å¯å†™å¯ä¸å†™Â 
Â Â Â Â },Â 
Â Â Â Â [1]Â =Â {Â 
Â Â Â Â Â Â Â  .startÂ =Â 13,Â Â //Â ä¸­æ–­å·Â æˆ–Â gpioÂ ç¼–å·Â 
Â Â Â Â Â Â Â  .endÂ =Â 13,Â 
Â Â Â Â Â Â Â  .flagsÂ =Â IORESOURCE_IRQ,Â Â Â //Â ä¸­æ–­ç±»å‹èµ„æºÂ Â  ---ç´¢å¼•å·è¿˜æ˜¯ 0ï¼Œåªæœ‰1 ä¸ª ä¸­æ–­ç±»å‹èµ„æºÂ 
Â Â Â Â },Â 
};Â 

//Â struct device devÂ ç»“æ„çš„ æˆå‘˜å‡½æ•°Â 
voidÂ mydevice_release(structÂ deviceÂ *dev){Â 
Â Â Â Â printk("This is mydevice_relsease\n");Â 
}

//Â platformÂ è®¾å¤‡ç»“æ„ä½“Â 
staticÂ structÂ platform_deviceÂ platform_device_testÂ =Â {Â 
Â Â Â  .nameÂ =Â "mydev",Â 
Â Â Â  .idÂ =Â -1,Â 
Â Â Â  .resourceÂ =Â my_device_resource,Â 
Â Â Â  .num_resourcesÂ =Â ARRAY_SIZE(my_device_resource),Â Â //Â ç”¨Â ARRAY_SIZE è·å– èµ„æºä¸ªæ•°Â 
Â Â Â  .devÂ =Â {Â 
Â Â Â Â Â Â Â  .releaseÂ =Â mydevice_release,Â 
Â Â Â Â };
};Â 

static structÂ platform_deviceÂ my_platform_deviceÂ = {Â 
Â Â Â  .nameÂ =Â "mydev",Â 
Â Â Â  .idÂ =Â -1,Â 
Â Â Â  .resourceÂ =Â my_device_resource,Â 
Â Â Â  .num_resourcesÂ =Â ARRAY_SIZE(my_device_resource),Â Â 
};Â 

//Â é©±åŠ¨å…¥å£å‡½æ•°Â 
staticÂ intÂ platform_device_init(void){Â 
Â Â Â Â //Â platformÂ è®¾å¤‡Â æ³¨å†ŒÂ 
Â Â Â Â platform_device_register(&platform_device_test);Â 
Â Â Â Â printk("platform_device_init!\n");Â 
Â Â Â Â returnÂ 0;Â 
}Â 

//Â é©±åŠ¨å‡ºå£å‡½æ•°Â 
staticÂ voidÂ platform_device_exit(void){Â 
Â Â Â Â //Â platformÂ è®¾å¤‡Â å¸è½½Â 
Â Â Â Â platform_device_unregister(&platform_device_test);Â 
Â Â Â Â printk("platform_device_exit!\n");Â 
}Â 

module_init(platform_device_init);Â 
module_exit(platform_device_exit);Â 

MODULE_LICENSE("GPL");
```

### **platform é©±åŠ¨ ï¼ˆdrive.cï¼‰**

**drive.c ä¸­å†™çš„æ˜¯ é©±åŠ¨ã€‚**

#### platform é©±åŠ¨æ³¨å†Œ

```c
void platform_driver_unregister(struct platform_driver *driver)
```

#### platform é©±åŠ¨å¸è½½

```c
void platform_driver_unregister(struct platform_driver *driver)
```

#### é©±åŠ¨ç»“æ„ä½“ï¼š

ç»“æ„ä½“ å®šä¹‰ åœ¨ `include/linux/platform_device.h` ä¸­ã€‚

**å¤´æ–‡ä»¶ï¼š**`#include <linux/platform_device.h>`
```c
structÂ platform_driverÂ Â 
{Â 
Â Â Â Â //Â æ¢æµ‹å‡½æ•°ï¼Œå½“é©±åŠ¨ä¸è®¾å¤‡åŒ¹é…æˆåŠŸä»¥åÂ probeÂ å‡½æ•°å°±ä¼šæ‰§è¡Œ,Â åœ¨Â probe å‡½æ•°ä¸­ è·å–ç¡¬ä»¶èµ„æºï¼Œç„¶åæ§åˆ¶å¤–è®¾Â 
Â Â Â Â intÂ (*probe)(structÂ platform_device *);Â Â //Â å‚æ•°æ˜¯Â è®¾å¤‡ç»“æ„ä½“Â 
Â Â Â Â Â Â Â Â Â //Â ç§»é™¤è®¾å¤‡ æ‰§è¡Œçš„å‡½æ•°ï¼šå½“Â driverÂ å’ŒÂ deviceÂ ä»»æ„ä¸€ä¸ªÂ removeÂ çš„æ—¶ï¼Œ å°±ä¼šæ‰§è¡Œè¯¥å‡½æ•°Â 
Â Â Â Â intÂ (*remove)(structÂ platform_deviceÂ *);Â Â 

Â Â Â Â //Â æ–°çš„Â ç§»é™¤è®¾å¤‡å‡½æ•°ï¼ŒÂ ç”¨äºÂ æ›´å¤æ‚çš„è®¾å¤‡ç§»é™¤æ“ä½œÂ 
Â Â Â Â voidÂ (*remove_new)(structÂ platform_deviceÂ *);Â 

Â Â Â Â /*Â ä¸‹é¢Â 3Â ä¸ªÂ æ˜¯Â ç”µæºç®¡ç†Â ç›¸å…³å‡½æ•°Â */Â 
Â Â Â Â voidÂ (*shutdown)(structÂ platform_deviceÂ *);Â Â //Â å…³æ‰è®¾å¤‡Â 
Â Â Â Â intÂ (*suspend)(structÂ platform_deviceÂ *,Â pm_message_tÂ state);Â Â //Â æŒ‚èµ·è®¾å¤‡Â 
Â Â Â Â intÂ (*resume)(structÂ platform_deviceÂ *);Â Â //Â æ¢å¤è®¾å¤‡Â 

Â Â Â Â structÂ device_driverÂ driver;Â Â //Â è®¾å¤‡ å…±ç”¨çš„ä¸€äº›å±æ€§ï¼ˆé©±åŠ¨ä¿¡æ¯ï¼‰Â Â --- name åœ¨è¿™é‡ŒÂ 

	// device_driverç›¸å½“äºåŸºç±»ï¼Œæä¾›äº†æœ€åŸºç¡€çš„é©±åŠ¨æ¡†æ¶ã€‚Â plaform_driverÂ ç»§æ‰¿äº†è¿™ä¸ªåŸºç±»ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šåˆæ·»åŠ äº†ä¸€äº›ç‰¹æœ‰çš„æˆå‘˜å˜é‡Â 

Â Â Â Â const structÂ platform_device_id *id_table;Â Â //Â è®¾å¤‡Â IDÂ è¡¨ï¼ˆæ•°ç»„ï¼‰--- name ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œå®šä¹‰Â 

	// idÂ ä¿¡æ¯å­˜æ”¾ç€platformdÂ é©±åŠ¨æ‰€æ”¯æŒçš„é©±åŠ¨ç±»å‹,Â å¦‚æœæœ‰è¿™ä¸ªÂ tableÂ ä¼šè‡ªåŠ¨éå†Â id_table[]Â 

Â Â Â Â boolÂ prevent_deferred_probe;Â Â //Â é˜²æ­¢å»¶è¿Ÿæ¢æµ‹æ ‡å¿—ï¼Œå¦‚æœä¸ºÂ trueï¼Œåˆ™ç¦æ­¢å»¶è¿Ÿæ¢æµ‹Â 

	boolÂ driver_managed_dma;Â Â Â //Â é©±åŠ¨ç®¡ç†Â DMAÂ çš„æ ‡å¿—ï¼Œå¦‚æœä¸ºÂ trueï¼Œåˆ™é©±åŠ¨è´Ÿè´£ç®¡ç†Â DMAÂ 

};
```

- **æ³¨æ„ï¼ï¼ï¼driver ç»“æ„ä½“ å’Œ id_table ä¸­ éƒ½æœ‰ nameï¼Œæ ¹æ® å†…æ ¸ç‰ˆæœ¬ä¸åŒï¼ŒåŒ¹é…ä¼˜å…ˆçº§å¯èƒ½æ˜¯ï¼š**
	é©±åŠ¨ åŒ¹é… è®¾å¤‡ æ—¶ï¼Œé¦–å…ˆ ä½¿ç”¨ driver ç»“æ„ä½“ ä¸­çš„ .driver.name å’ŒÂ  è®¾å¤‡åç§° æ¯”è¾ƒÂ  Â -- å¼ºç»‘å®šï¼Œå”¯ä¸€æ ‡å‡†
	å¦‚æœ id_table å­˜åœ¨ï¼Œä½¿ç”¨ id_table ç»“æ„ä½“æ•°ç»„ ä¸­çš„ è®¾å¤‡ nameï¼Œ
- **ä¹Ÿå¯èƒ½æ˜¯ï¼š**
	å¦‚æœ id_table å­˜åœ¨ï¼Œä¼˜å…ˆä½¿ç”¨ id_table ç»“æ„ä½“æ•°ç»„ ä¸­çš„ è®¾å¤‡ nameï¼Œ
	å¦‚æœ id_table ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨ driver ç»“æ„ä½“ ä¸­çš„ .driver.name
	
	- driver.name â‰ˆ é©¾ç…§ä¸Šçš„åå­—ï¼Œç”¨æ¥åŒ¹é…æ˜¯å¦èƒ½å¼€è¿™è¾†è½¦
	id_table[].name â‰ˆ ä½ å¯¹ä¸åŒè½¦å‹ï¼ˆåŒå“ç‰Œï¼‰æœ‰é¢å¤–è¯´æ˜ï¼Œæ¯”å¦‚è½¿è½¦ã€è´§è½¦ã€ç”µè½¦...

#### platform_device_id ç»“æ„ä½“

**å¤´æ–‡ä»¶ï¼š**`#include <linux/mod_devicetable.h>`
```c
structÂ platform_device_idÂ Â 
{Â 
Â Â Â Â //Â name:Â ä¸€ä¸ªå­—ç¬¦æ•°ç»„ï¼Œç”¨äºå­˜å‚¨è®¾å¤‡åç§°ï¼Œé•¿åº¦ä¸ºÂ PLATFORM_NAME_SIZEÂ 
Â Â Â Â charÂ name[PLATFORM_NAME_SIZE];Â 

Â Â Â Â //Â driver_data:Â æ˜¯é©±åŠ¨åœ¨è®¾å¤‡åŒ¹é…æˆåŠŸåï¼Œä»Â id_tableÂ ä¸­æ‹¿æ¥ç”¨çš„ä¸€ä¸ªÂ è‡ªå®šä¹‰æ•°å­—ç¼–å·ï¼ˆæˆ–è€…æŒ‡é’ˆï¼‰ï¼Œç”¨æ¥åŒºåˆ†ä¸åŒå‹å·/ç‰ˆæœ¬/å˜ä½“çš„è®¾å¤‡ã€‚Â 
Â Â Â Â kernel_ulong_tÂ driver_data;Â 
};
```


**è¿™å°±åƒæ˜¯â€œç»™æ¯ç§è®¾å¤‡è´´ä¸€ä¸ªç¼–å·â€ï¼Œä½ æ‹¿ç¼–å·æ¥åˆ†æƒ…å†µå¤„ç†ã€‚**
- **ä¾‹å¦‚ï¼šåœ¨ id_table ä¸­å†™ï¼š**

```c
static const struct platform_device_id my_id_table[] = {
Â Â Â  { .name = "mydev",Â Â Â Â Â Â  .driver_data = 0 },
Â Â Â  { .name = "mydev-lite",Â  .driver_data = 1 },
Â Â Â  { .name = "mydev-pro",Â Â  .driver_data = 2 },
Â Â Â  { }
};
```
- **ç„¶ååœ¨ probe() ä¸­è¿™æ ·å¤„ç†ï¼š**

```c
static int my_probe(struct platform_device *pdev){
Â Â Â Â Â Â Â  const struct platform_device_id *id = platform_get_device_id(pdev);
Â Â Â Â Â Â Â  switch (id->driver_data) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  case 0: pr_info("mydev: init full feature\n"); break;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  case 1: pr_info("mydev-lite: init lite mode\n"); break;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  case 2: pr_info("mydev-pro: init pro version\n"); break;
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  return 0;
}
```

#### device_driver ç»“æ„ä½“

**ç»“æ„ä½“ å®šä¹‰ åœ¨ `include/linux/device/driver.h` ä¸­ã€‚**

**å¤´æ–‡ä»¶ï¼š**`#include <linux/device/device.h>`
```c
structÂ device_driverÂ Â 
{Â 
Â Â Â Â constÂ charÂ Â Â Â Â Â *name; //Â é©±åŠ¨ç¨‹åºçš„åç§°Â 
Â Â Â Â const structÂ bus_typeÂ Â Â *bus;Â Â //Â é©±åŠ¨ç¨‹åºæ‰€å±çš„æ€»çº¿ç±»å‹Â 
Â Â Â Â structÂ moduleÂ Â Â Â Â Â Â *owner; //Â é©±åŠ¨ç¨‹åºæ‰€å±çš„æ¨¡å—Â 
Â Â Â Â constÂ charÂ Â Â Â Â Â *mod_name;Â Â Â 
Â Â Â Â boolÂ suppress_bind_attrs;Â Â Â Â Â Â Â //Â æ˜¯å¦æŠ‘åˆ¶ç»‘å®šå±æ€§Â 
Â Â Â Â enumÂ probe_typeÂ probe_type; //Â æ¢æµ‹ç±»å‹Â 
Â Â Â Â const structÂ of_device_idÂ Â Â *of_match_table;Â //Â è®¾å¤‡æ ‘é©±åŠ¨åŒ¹é…è¡¨Â 
Â Â Â Â const structÂ acpi_device_id *acpi_match_table; //Â ACPIåŒ¹é…è¡¨Â 
Â Â Â Â intÂ (*probe) (structÂ device *dev); //Â æ¢æµ‹å‡½æ•°ï¼Œç”¨äºæ£€æµ‹è®¾å¤‡Â 
Â Â Â Â voidÂ (*sync_state)(structÂ device *dev); //Â åŒæ­¥çŠ¶æ€å‡½æ•°Â 
Â Â Â Â intÂ (*remove) (structÂ device *dev); //Â ç§»é™¤å‡½æ•°ï¼Œç”¨äºç§»é™¤è®¾å¤‡Â 
Â Â Â Â voidÂ (*shutdown) (structÂ device *dev); //Â å…³é—­å‡½æ•°ï¼Œç”¨äºå…³é—­è®¾å¤‡Â 
Â Â Â Â intÂ (*suspend) (structÂ device *dev,Â pm_message_tÂ state); //Â æŒ‚èµ·å‡½æ•°ï¼Œç”¨äºæŒ‚èµ·è®¾å¤‡Â 
Â Â Â Â intÂ (*resume) (structÂ device *dev); //Â æ¢å¤å‡½æ•°ï¼Œç”¨äºæ¢å¤è®¾å¤‡Â 
Â Â Â Â const structÂ attribute_group **groups; //Â å±æ€§ç»„Â 
Â Â Â Â const structÂ attribute_group **dev_groups; //Â è®¾å¤‡å±æ€§ç»„Â 
Â Â Â Â const structÂ dev_pm_ops *pm; //Â ç”µæºç®¡ç†æ“ä½œÂ 
Â Â Â Â voidÂ (*coredump) (structÂ device *dev); //Â æ ¸å¿ƒè½¬å‚¨å‡½æ•°Â 
Â Â Â Â structÂ driver_private *p; //Â ç§æœ‰æ•°æ®æŒ‡é’ˆÂ 
};
```


#### device_driver ç»“æ„ä½“

**`include/linux/mod_devicetable.h`**

**å¤´æ–‡ä»¶ï¼š**`#include <linux/mod_devicetable.h>`
```c
structÂ of_device_idÂ Â 
{Â 
Â Â Â Â //Â name:Â ç”¨äºå­˜å‚¨è®¾å¤‡çš„åç§°ï¼Œæœ€å¤š31ä¸ªå­—ç¬¦åŠ ä¸Šä¸€ä¸ªç»ˆæ­¢ç¬¦Â 
Â Â Â Â charÂ Â Â Â name[32];Â 
Â Â Â Â //Â type:Â ç”¨äºå­˜å‚¨è®¾å¤‡çš„ç±»å‹ï¼Œæœ€å¤š31ä¸ªå­—ç¬¦åŠ ä¸Šä¸€ä¸ªç»ˆæ­¢ç¬¦Â 
Â Â Â Â charÂ Â Â Â type[32];Â 
Â Â Â Â //Â compatible:Â ç”¨äºå­˜å‚¨è®¾å¤‡çš„å…¼å®¹å­—ç¬¦ä¸²ï¼Œæœ€å¤š127ä¸ªå­—ç¬¦åŠ ä¸Šä¸€ä¸ªç»ˆæ­¢ç¬¦Â 
Â Â Â Â //Â å…¼å®¹å­—ç¬¦ä¸²ç”¨äºæè¿°è®¾å¤‡ä¸å“ªäº›é©±åŠ¨ç¨‹åºå…¼å®¹Â 
Â Â Â Â charÂ Â Â Â compatible[128];Â 
Â Â Â Â //Â data:Â æŒ‡å‘ä¸è®¾å¤‡ç›¸å…³çš„æ•°æ®çš„æŒ‡é’ˆï¼Œå¯ä»¥æ˜¯ä»»æ„ç±»å‹çš„æ•°æ®Â 
Â Â Â Â //Â è¯¥æ•°æ®é€šå¸¸ç”¨äºä¼ é€’è®¾å¤‡ç‰¹å®šçš„ä¿¡æ¯æˆ–å‚æ•°ç»™é©±åŠ¨ç¨‹åºÂ 
Â Â Â Â constÂ voidÂ *data;Â 
};
```

**driver.c ç¤ºä¾‹ï¼š**
```c
#includeÂ <linux/module.h>Â 
#includeÂ <linux/init.h>Â 
#includeÂ <linux/ioport.h>Â 
#includeÂ <linux/platform_device.h>Â 
#includeÂ <linux/mod_devicetable.h>Â 

//Â platformÂ è®¾å¤‡ æ¢æµ‹Â ï¼Œè·å–Â è®¾å¤‡ä¿¡æ¯ è¯¦ç»†æ–¹æ³•è§ä¸‹æ–¹Â 
intÂ mydriver_probe(structÂ platform_deviceÂ *dev){Â 
Â Â Â Â printk("This is mydriver_probe\n");Â 
Â Â Â Â returnÂ 0;Â 
}Â 

//Â platformÂ è®¾å¤‡ ç§»é™¤Â 
intÂ mydriver_remove(structÂ platform_deviceÂ *dev){Â 
Â Â Â Â printk("This is mydriver_remove\n");Â 
Â Â Â Â returnÂ 0;Â 
}Â 

//Â platformÂ è®¾å¤‡Â IDÂ è¡¨Â 
constÂ structÂ platform_device_idÂ mydriver_id_table[]Â =Â {Â 
Â Â Â Â {Â .nameÂ =Â "mydev"Â },Â Â Â //Â ğŸ‘ˆÂ è®¾å¤‡åç§°Â 
Â Â Â Â { }Â Â //Â ğŸ‘ˆÂ å¿…é¡»ç©ºç»“æ„ä½“ä½œä¸ºç»“å°¾å“¨å…µÂ 
};Â 

//Â platformÂ é©±åŠ¨ç»“æ„ä½“Â Â 
structÂ platform_driverÂ platform_driver_testÂ =Â {Â 
Â Â Â  .probeÂ =Â mydriver_probe,Â 
Â Â Â  .removeÂ =Â mydriver_remove,Â 
Â Â Â  .driverÂ =Â {Â 
Â Â Â Â Â Â Â  .nameÂ =Â "mydev",Â Â Â //Â driveÂ çš„åå­—åœ¨è¿™é‡Œï¼Œå¿…é¡»å’ŒÂ deviceÂ ä¸€æ ·Â 
Â Â Â Â Â Â Â  .ownerÂ =Â THIS_MODULE,Â Â Â //Â driverÂ çš„ æ‹¥æœ‰è€… å°±æ˜¯è¿™ä¸ªæ¨¡å—Â THIS_MODULEÂ æŒ‡å‘ å½“å‰æ¨¡å—çš„æŒ‡é’ˆÂ 
Â Â Â Â },Â 
Â Â Â  .id_tableÂ =Â mydriver_id_table,Â 
};Â 

//Â é©±åŠ¨å…¥å£å‡½æ•°Â 
staticÂ intÂ platform_driver_init(void){Â 
Â Â Â Â printk("platform_device_init!\n");Â 
Â Â Â Â //Â platformÂ è®¾å¤‡ æ³¨å†ŒÂ 
Â Â Â Â platform_driver_unregister(&platform_driver_test);Â 
Â Â Â Â returnÂ 0;Â 
}Â 

//Â é©±åŠ¨å‡ºå£å‡½æ•°Â 
staticÂ voidÂ platform_driver_exit(void){Â 
Â Â Â Â printk("platform_device_exit!\n");Â 
Â Â Â Â //Â platformÂ è®¾å¤‡ å¸è½½Â 
Â Â Â Â platform_driver_unregister(&platform_driver_test);Â 
}Â 

module_init(platform_driver_init);Â 
module_exit(platform_driver_exit);Â 

MODULE_LICENSE("GPL");
```


### probe å‡½æ•°ç¼–å†™ï¼ˆ

å½“è®¾å¤‡ï¼ˆdeviceï¼‰å’Œé©±åŠ¨ï¼ˆdriverï¼‰**åŒ¹é…æˆåŠŸ**ä»¥åï¼Œä¼šæ‰§è¡Œé©±åŠ¨ï¼ˆdriverï¼‰ä¸­çš„ **probe å‡½æ•°**ï¼Œ

æ‰€ä»¥æˆ‘ä»¬è¦ **é€šè¿‡ é©±åŠ¨ï¼ˆdriverï¼‰ä¸­çš„ probeå‡½æ•°** ï¼Œæ‹¿åˆ° **è®¾å¤‡ï¼ˆdeviceï¼‰ä¸­çš„ç¡¬ä»¶èµ„æº**ï¼Œ ä»è€Œ æ§åˆ¶ç¡¬ä»¶ã€‚

##### æ–¹æ³• 1ï¼š

// å‚æ•°æ˜¯ è®¾å¤‡ç»“æ„ä½“ï¼Œç›´æ¥è®¿é—®ç»“æ„ä½“ å³å¯ è·å– ç¡¬ä»¶èµ„æºä¿¡æ¯
```c
int (*probe)(struct platform_device *);
```

##### æ–¹æ³• 2ï¼š æ¨èï¼ï¼ï¼

**é€šè¿‡ å®˜æ–¹ å‡½æ•° è·å– ç¡¬ä»¶èµ„æºä¿¡æ¯**

```c
externÂ structÂ resource *platform_get_resource(structÂ platform_device *,Â unsigned intÂ type,Â unsigned intÂ num);Â å‚æ•°ï¼šÂ 
ç¬¬ä¸€ä¸ªå‚æ•°ï¼šplatform_deviceç»“æ„ä½“ã€‚Â 
ç¬¬äºŒä¸ªå‚æ•°ï¼šèµ„æºçš„ç±»å‹ã€‚---Â ç›¸å½“äºÂ flagsÂ 
ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šç´¢å¼•å·ã€‚èµ„æºå¤„åœ¨åŒç±»èµ„æºçš„å“ªä¸ªä½ç½®ä¸Šã€‚åŒç±»èµ„æºæŒ‡çš„æ˜¯flagsæ˜¯ä¸€æ ·çš„åŒç±»èµ„æºã€‚Â ä¾‹å¦‚ï¼šÂ 

staticÂ structÂ resourceÂ my_device_resource[]Â =Â Â 
{Â Â Â //Â 2Â ä¸ªèµ„æºï¼Œç§ç±»ä¸åŒÂ 
Â Â Â Â [0]Â =Â {Â Â Â Â 
Â Â Â Â Â Â Â  .startÂ =Â 0xFDD60000,Â Â //Â å¯„å­˜å™¨èµ·å§‹åœ°å€Â 
Â Â Â Â Â Â Â  .endÂ =Â 0xFDD60004,Â Â Â //Â å¯„å­˜å™¨ç»“æŸåœ°å€Â 
Â Â Â Â Â Â Â Â .flagsÂ =Â IORESOURCE_MEM,Â Â //Â å†…å­˜ç±»å‹èµ„æºÂ Â ---ç´¢å¼•å·æ˜¯ 0ï¼Œåªæœ‰1 ä¸ª ä¸­å†…å­˜å‹èµ„æºÂ 
Â Â Â Â Â Â Â  .nameÂ =Â "reg",Â Â //Â nameÂ å¯å†™å¯ä¸å†™Â 
Â Â Â Â },Â 
Â Â Â Â [1]Â =Â {Â 
Â Â Â Â Â Â Â  .startÂ =Â 13,Â Â //Â ä¸­æ–­å·Â æˆ–Â gpioÂ ç¼–å·Â \
Â Â Â Â Â Â Â  .endÂ =Â 13,Â 
Â Â Â Â Â Â Â  .flagsÂ =Â IORESOURCE_IRQ,Â Â Â //Â ä¸­æ–­ç±»å‹èµ„æºÂ Â Â ---ç´¢å¼•å·è¿˜æ˜¯ 0ï¼Œåªæœ‰1 ä¸ª ä¸­æ–­ç±»å‹èµ„æºÂ 
Â Â Â Â },Â 
};
```

**ç¤ºä¾‹ï¼š**
```c
//å®šä¹‰ç»“æ„ä½“ç”¨äºå­˜å‚¨Â platform_get_resourceå‡½æ•° è·å–çš„è®¾å¤‡èµ„æºä¿¡æ¯Â 
structÂ resource *my_resouces;Â 
intÂ mydriver_probe(structÂ platform_device *dev)
{Â 
Â Â Â Â printk("This is mydriver_probe\n");Â 
Â Â Â Â 
Â Â Â Â //Â æ–¹æ³•Â 1ï¼šç›´æ¥é€šè¿‡è®¿é—®Â platform_device *devÂ è·å– è®¾å¤‡ä¿¡æ¯Â 
Â Â Â Â printk("IRQ isÂ %lld\n",Â devÂ ->Â resource[1].start);Â Â //Â è·å–èµ„æºÂ 1Â çš„ ä¸­æ–­å·Â 

Â Â Â Â //Â æ–¹æ³•Â 2ï¼šé€šè¿‡å‡½æ•° è·å–Â 
Â Â Â Â my_resoucesÂ =Â platform_get_resource(dev,Â IORESOURCE_IRQ,Â 0);Â //Â è·å– ç±»å‹ä¸ºä¸­æ–­ï¼Œä¸­æ–­ç´¢å¼•å·ä¸ºÂ 0Â çš„èµ„æºÂ 
Â Â Â Â printk("IRQ isÂ %lld\n",Â my_resoucesÂ ->Â resource[1].start);Â //Â è·å–èµ„æºÂ 1Â çš„ ä¸­æ–­å·Â 

Â Â Â Â returnÂ 0;Â 
}
```


### **platform æ€»çº¿**

platformè®¾å¤‡ å’Œ platformé©±åŠ¨ï¼Œç›¸å½“äºæŠŠè®¾å¤‡å’Œé©±åŠ¨åˆ†ç¦»äº†ï¼Œ**éœ€è¦ platform æ€»çº¿è¿›è¡Œé…**ï¼Œ platform è®¾å¤‡å’Œ platform é©±åŠ¨è¿›è¡Œå†…æ ¸æ³¨å†Œæ—¶ï¼Œ éƒ½æ˜¯æ³¨å†Œåˆ°æ€»çº¿ä¸Šã€‚

##### åœ¨ Linux å†…æ ¸ä¸­ä½¿ç”¨Â bus_type ç»“æ„ä½“ è¡¨ç¤ºæ€»çº¿ã€‚

- å¤§éƒ¨åˆ†é©±åŠ¨å¼€å‘è€…ä¸éœ€è¦æ‰‹åŠ¨ç¼–å†™ bus_type
- âœ… ä½†å¦‚æœä½ è¦å®ç°è‡ªå®šä¹‰æ€»çº¿ï¼ˆbusï¼‰æ¡†æ¶ï¼Œæ¯”å¦‚ï¼š
	- è‡ªå®šä¹‰ platform æ€»çº¿ï¼ˆMFD å­è®¾å¤‡æ¡†æ¶ï¼‰
	- è™šæ‹Ÿ busï¼ˆvbusï¼‰æˆ–æ¨¡æ‹Ÿè®¾å¤‡æ¡†æ¶
	- æƒ³å†™ä¸€ä¸ªå®Œæ•´çš„â€œbus-driver-deviceâ€æ¨¡å‹æ¨¡å—

ğŸ‘‰ é‚£å°±éœ€è¦æ³¨å†Œå¹¶å®ç°ä¸€ä¸ª struct bus_type ç»“æ„ä½“

**å¤´æ–‡ä»¶åªè¦åŒ…å«ï¼š**`#include <linux/device.h>`
(#include <linux/device/bus.h> é‡Œå®šä¹‰äº† struct bus_typeï¼Œå¹¶ä¸”ä¼šè¢« <linux/device.h> é—´æ¥åŒ…å«)
```c
structÂ bus_typeÂ Â 
{Â 
Â Â Â Â constÂ charÂ Â Â Â Â Â *name;Â Â Â Â Â Â Â //Â æŒ‡å‘æ€»çº¿åç§°çš„æŒ‡é’ˆÂ 
Â Â Â Â constÂ charÂ Â Â Â Â Â *dev_name;Â Â Â //Â æŒ‡å‘è®¾å¤‡åç§°çš„æŒ‡é’ˆÂ 
Â Â Â Â constÂ structÂ attribute_groupÂ **bus_groups;Â Â Â //Â æŒ‡å‘æ€»çº¿å±æ€§ç»„çš„æŒ‡é’ˆæ•°ç»„Â 
Â Â Â Â constÂ structÂ attribute_groupÂ **dev_groups;Â Â Â //Â æŒ‡å‘è®¾å¤‡å±æ€§ç»„çš„æŒ‡é’ˆæ•°ç»„Â 
Â Â Â Â constÂ structÂ attribute_groupÂ **drv_groups;Â Â Â //Â æŒ‡å‘é©±åŠ¨å±æ€§ç»„çš„æŒ‡é’ˆæ•°ç»„Â 
Â Â Â Â intÂ (*match)(structÂ device *dev,Â structÂ device_driver *drv);Â Â Â //Â åŒ¹é…è®¾å¤‡å’Œé©±åŠ¨çš„å‡½æ•°æŒ‡é’ˆÂ 

matchÂ å‡½æ•°ï¼šå®Œæˆè®¾å¤‡å’Œé©±åŠ¨ä¹‹é—´åŒ¹é…çš„ï¼Œæ€»çº¿ä½¿ç”¨Â matchÂ å‡½æ•°æ¥æ ¹æ®æ³¨å†Œçš„è®¾å¤‡æ¥æŸ¥æ‰¾å¯¹åº”çš„é©±åŠ¨ï¼Œæˆ–è€…æ ¹æ®æ³¨å†Œçš„é©±åŠ¨æ¥æŸ¥æ‰¾ç›¸åº”çš„è®¾å¤‡ï¼Œå› æ­¤Â æ¯ä¸€æ¡æ€»çº¿éƒ½å¿…é¡»å®ç°æ­¤å‡½æ•°ã€‚Â 

matchÂ å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼šÂ devÂ Â ->Â Â deviceè®¾å¤‡ï¼ŒdrvÂ ->Â device_driverÂ é©±åŠ¨Â 

Â Â Â Â intÂ (*uevent)(constÂ structÂ deviceÂ *dev,Â structÂ kobj_uevent_envÂ *env);Â Â //Â å¤„ç†ueventäº‹ä»¶çš„å‡½æ•°æŒ‡é’ˆÂ 
Â Â Â Â intÂ (*probe)(structÂ deviceÂ *dev);Â Â //Â æ¢æµ‹è®¾å¤‡çš„å‡½æ•°æŒ‡é’ˆÂ 
Â Â Â Â voidÂ (*sync_state)(structÂ deviceÂ *dev);Â Â Â //Â åŒæ­¥è®¾å¤‡çŠ¶æ€çš„å‡½æ•°æŒ‡é’ˆÂ 
Â Â Â Â voidÂ (*remove)(structÂ deviceÂ *dev);Â Â //Â ç§»é™¤è®¾å¤‡çš„å‡½æ•°æŒ‡é’ˆÂ 
Â Â Â Â voidÂ (*shutdown)(structÂ deviceÂ *dev);Â Â //Â å…³é—­è®¾å¤‡çš„å‡½æ•°æŒ‡é’ˆÂ 
Â Â Â Â intÂ (*online)(structÂ deviceÂ *dev);Â Â Â //Â å°†è®¾å¤‡è®¾ç½®ä¸ºåœ¨çº¿çŠ¶æ€çš„å‡½æ•°æŒ‡é’ˆÂ 
Â Â Â Â intÂ (*offline)(structÂ deviceÂ *dev);Â Â Â //Â å°†è®¾å¤‡è®¾ç½®ä¸ºç¦»çº¿çŠ¶æ€çš„å‡½æ•°æŒ‡é’ˆÂ 
Â Â Â Â intÂ (*suspend)(structÂ deviceÂ *dev,Â pm_message_tÂ state);Â Â //Â æŒ‚èµ·è®¾å¤‡çš„å‡½æ•°æŒ‡é’ˆÂ 
Â Â Â Â intÂ (*resume)(structÂ deviceÂ *dev);Â Â Â //Â æ¢å¤è®¾å¤‡çš„å‡½æ•°æŒ‡é’ˆÂ 
Â Â Â Â intÂ (*num_vf)(structÂ deviceÂ *dev);Â Â Â //Â è·å–è®¾å¤‡è™šæ‹Ÿå‡½æ•°æ•°é‡çš„å‡½æ•°æŒ‡é’ˆÂ 
Â Â Â Â intÂ (*dma_configure)(structÂ deviceÂ *dev);Â Â Â //Â é…ç½®DMAçš„å‡½æ•°æŒ‡é’ˆÂ 
Â Â Â Â voidÂ (*dma_cleanup)(structÂ deviceÂ *dev);Â Â Â //Â æ¸…ç†DMAçš„å‡½æ•°æŒ‡é’ˆÂ 

Â Â Â Â constÂ structÂ dev_pm_opsÂ *pm;Â Â Â //Â æŒ‡å‘è®¾å¤‡ç”µæºç®¡ç†æ“ä½œçš„æŒ‡é’ˆÂ 
Â Â Â Â constÂ structÂ iommu_opsÂ *iommu_ops;Â Â //Â æŒ‡å‘IOMMUæ“ä½œçš„æŒ‡é’ˆÂ 
Â Â Â Â boolÂ need_parent_lock;Â Â Â //Â æ˜¯å¦éœ€è¦é”å®šçˆ¶è®¾å¤‡çš„å¸ƒå°”å€¼Â 
};
```


#### platform æ€»çº¿ æ˜¯ bus_type çš„ä¸€ä¸ªå…·ä½“å®ä¾‹

```c
structÂ bus_typeÂ platform_bus_typeÂ = {Â 
Â Â Â  .nameÂ =Â "platform",Â 
Â Â Â  .dev_groupsÂ =Â platform_dev_groups,Â 
Â Â Â Â .matchÂ =Â platform_match,Â //platform_matchÂ åŒ¹é…å‡½æ•°ï¼Œç”¨æ¥åŒ¹é…æ³¨å†Œåˆ°Â platformÂ æ€»çº¿çš„è®¾å¤‡å’Œé©±åŠ¨Â 
Â Â Â  .ueventÂ =Â platform_uevent,Â 
Â Â Â  .pmÂ =Â &platform_dev_pm_ops,Â 
};
```


#### drivers/base/platform.c
```c
staticÂ intÂ platform_match(structÂ deviceÂ *dev,Â structÂ device_driverÂ *drv)Â 
{Â 
Â Â Â Â structÂ platform_deviceÂ *pdevÂ =Â to_platform_device(dev);Â 
Â Â Â Â structÂ platform_driverÂ *pdrvÂ =Â to_platform_driver(drv);Â 

Â Â Â Â /*Â When driver_override is set, only bind to the matching driverÂ */Â 
Â Â Â Â ifÂ (pdev->driver_override)Â 
Â Â Â Â Â Â Â Â returnÂ !strcmp(pdev->driver_override,Â drv->name);Â 

Â Â Â Â /*Â Attempt an OF style match firstÂ */Â 
Â Â Â Â ifÂ (of_driver_match_device(dev,Â drv))Â 
Â Â Â Â Â Â Â Â returnÂ 1;Â 

Â Â Â Â /*Â Then try ACPI style matchÂ */Â 
Â Â Â Â ifÂ (acpi_driver_match_device(dev,Â drv))Â 
Â Â Â Â Â Â Â Â returnÂ 1;Â 

Â Â Â Â /*Â Then try to match against the id tableÂ */Â 
Â Â Â Â ifÂ (pdrv->id_table)Â 
Â Â Â Â Â Â Â Â returnÂ platform_match_id(pdrv->id_table,Â pdev)Â !=Â NULL;Â 

Â Â Â Â /*Â fall-back to driver name matchÂ */Â 
Â Â Â Â returnÂ (strcmp(pdev->name,Â drv->name)Â ==Â 0);Â 
}
```